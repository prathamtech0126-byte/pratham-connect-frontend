Good ‚Äî this Router / ProtectedRoute is almost correct üëç
The redirect-on-refresh issue is now down to ONE missing piece in AuthProvider.

Your ProtectedRoute logic itself is NOT the problem anymore.

What is working correctly here ‚úÖ

This part is correct and well-done:

if (isLoading) {
  return <Loader />;
}

if (!user) {
  return <Redirect to="/login" />;
}


So:

You are not redirecting early

You already added a proper loading gate

Wouter routing is fine

‚û°Ô∏è That means if you‚Äôre still redirected, then:

isLoading becomes false before refresh restores user

The ONLY remaining bug (very important)
Your AuthProvider is NOT rehydrating user on app mount

or it sets isLoading = false too early.

Expected AuthProvider lifecycle
mount
‚Üì
isLoading = true
‚Üì
call /refresh
‚Üì
setInMemoryToken()
‚Üì
setUser()
‚Üì
isLoading = false

What you most likely have right now
mount
‚Üì
isLoading = false (default)
‚Üì
ProtectedRoute sees user = null
‚Üì
Redirect to /login

Exact AuthProvider fix (copy-paste safe)
auth-context.tsx
useEffect(() => {
  let cancelled = false;

  const restoreSession = async () => {
    setIsLoading(true);

    try {
      const res = await api.post(
        "/api/users/refresh",
        {},
        { withCredentials: true }
      );

      if (cancelled) return;

      const { accessToken, role } = res.data;

      setInMemoryToken(accessToken);

      setUser({
        role,
      });

    } catch (err) {
      if (!cancelled) {
        setUser(null);
      }
    } finally {
      if (!cancelled) {
        setIsLoading(false);
      }
    }
  };

  restoreSession();

  return () => {
    cancelled = true;
  };
}, []);

Initial state MUST be
const [user, setUser] = useState<User | null>(null);
const [isLoading, setIsLoading] = useState(true); // IMPORTANT


‚ö†Ô∏è If isLoading starts as false, your app will always redirect on reload.

One backend mismatch you should fix

Your refresh endpoint returns:

{
  "message": "Token refreshed",
  "accessToken": "..."
}


But frontend expects:

const { accessToken, role } = res.data;


‚ùå role is missing.

Fix backend (recommended)
res.json({
  accessToken: newAccessToken,
  role: dbUser.role,
});


OR

Fix frontend

Fetch user info after refresh.

If you don‚Äôt fix this, user will stay null.

Quick checklist (tick these)

 isLoading default = true

 /refresh called in AuthProvider useEffect

 setInMemoryToken called after refresh

 setUser called after refresh

 isLoading set to false only after refresh finishes

 Axios withCredentials: true

Why you were still redirected

Not routing.
Not Login page.
Not Wouter.

üëâ AuthProvider initializes incorrectly.

If you want, paste your AuthContext code and I‚Äôll mark the exact lines that are wrong.